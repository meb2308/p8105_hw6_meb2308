---
title: "P8105 Homework 6 Solutions"
author: Meghan Bellerose
date: November 21, 2020
output:
    html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

# Problem 1

```{r}
homicide_df = 
  read_csv("./data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = ", "),
    victim_age = as.numeric(victim_age),
    resolution = case_when(
      disposition == "Closed without arrest" ~ 0,
      disposition == "Open/No arrest"        ~ 0,
      disposition == "Closed by arrest"      ~ 1,
    )
  ) %>% 
  filter(city_state != "Tulsa, AL",
         victim_race %in% c("White", "Black")) %>% 
  select(city_state, resolution, victim_age, victim_race, victim_sex)
```

Start with one city.

```{r}
baltimore_df = 
  homicide_df %>% 
  filter(city_state == "Baltimore, MD")
glm(resolution ~ victim_age + victim_race + victim_sex,
    data = baltimore_df,
    family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
  select(term, OR, starts_with("CI")) %>% 
  knitr::kable(digits = 3)
```

Try this across cities.

```{r}
model_results_df = 
  homicide_df %>% 
  nest(data = -city_state) %>% 
  mutate(
    models = 
      map(.x = data, 
          ~glm(resolution ~ victim_age + victim_race + victim_sex,
            data = .x,
            family = binomial())),
    results = map(models, broom::tidy)
  ) %>% 
  select(city_state, results) %>% 
  unnest(results) %>% 
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  ) %>% 
   select(city_state, term, OR, starts_with("CI"))
```

```{r}
model_results_df %>% 
  filter(term == "victim_sexMale") %>% 
  mutate(city_state = fct_reorder(city_state, OR)) %>% 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.6))
```

This plot shows the adjusted odds ratios and confidence intervals for solving homicides comparing Black victims to white victims in different US cities. We can see that in New York City and Baton Route, the odds of solving a homicide involving a Black American is lower than the odds of solving it for a White American.

# Problem 2

This problem uses data on children's birthweights. In the following code chunks, I show the process I used to come up with a linear regression model with the outcome birtweight `btw`. 

#### Fitting a model

**1. Load and clean the dataset for regression analysis** 

```{r}
birthweight_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    mrace = as.character(mrace), 
    mrace = recode(mrace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other"),
    mrace = fct_infreq(mrace),
    babysex = as.character(babysex),
    babysex = recode(babysex, "1" = "Male", "2" = "Female"),
    babysex = fct_infreq(babysex),
    frace = as.character(frace), 
    frace = recode(frace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "9" = "Unknown"),
    frace = fct_infreq(frace),
    malform = as.character(malform),
    malform = recode(malform, "0" = "Absent", "1" = "Present"),
    malform = fct_infreq(malform)
    )
  
```

**2. Look at the data**

I'll first explore the three predictors that have been found to be associated with birthweight in published analyses. 

Birthweight by mother's age at delivery

```{r}
birthweight_df %>% 
  ggplot(aes(x = momage, y = bwt, color = mrace)) +
  geom_point()
```


Birthweight by average number of cigarettes smoked per day during pregnancy

```{r}
birthweight_df %>% 
  ggplot(aes(x = smoken, y = bwt, color = mrace)) +
  geom_point()
```

**3. Fit data**

Based on these plots, it looks like race and mom's age at birth may have a linear relationship with birthweight, so I will fit a linear model using both of those predictors. 

```{r}
fit = lm(bwt ~ momage + mrace, data = birthweight_df)
```

```{r}
fit %>% 
  broom::glance()
```

```{r}
fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(term = str_replace(term, "momage", "Mom's Age at Birth")) %>% 
  mutate(term = str_replace(term, "mrace", "Race: ")) %>% 
  knitr::kable(digits = 3)
```

**4. Add residuals**

```{r}
birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = mrace, y = resid)) +
  geom_violin()

birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = momage, y = resid)) +
  geom_point() +
  facet_wrap(. ~ mrace)
```

```{r}
modelr::add_predictions(birthweight_df, fit)
```
**5. Make plot of modeled residuals against fitted values**



#### Now I will compare my model to two others

Look at cross validation lecture
* Length at birth and gestational age as predictors (main effects only)
* Head circumference, length, sex, and all interactions between these  three



# Problem 3

This problem uses 2017 Central Park weather data 

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

Test with one model fit first before bootstrapping
from broom tidy, pull values, multiply, and take log

