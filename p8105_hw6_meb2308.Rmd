---
title: "P8105 Homework 6 Solutions"
author: Meghan Bellerose
date: November 21, 2020
output:
    html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r}
library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

set.seed(1)
```

# Problem 1


```{r}
homicides_df = 
  read_csv("data/homicide-data.csv") %>% 
  unite("city_state", city:state, sep = ", ", remove = TRUE) %>% 
  mutate(
    resolved = as.numeric(disposition == "Closed by arrest"),
    victim_age = as.numeric(victim_age),
    victim_race = fct_relevel(victim_race, "White")) %>% 
  filter(city_state != c("Tulsa, AL", "Dallas, TX", "Kansas City, MO", "Phoenix, AZ")) %>% 
  select(city_state, resolved, victim_age, victim_race, victim_sex)
```

```{r}
baltimore_df = 
  homicides_df %>% 
  filter(city_state == "Baltimore, MD")
```

```{r}
fit_logistic = 
  baltimore_df %>% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) 
```

```{r}
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  select(term, log_OR = estimate, OR, p.value) %>% 
  knitr::kable(digits = 3)
```

```{r}
baltimore_df %>% 
  modelr::add_predictions(fit_logistic) %>% 
  mutate(fitted_prob = boot::inv.logit(pred))
```
Here is a plot showing the estimated ORs and CIs for each city. 


Comment on plot...

# Problem 2

This problem uses data on children's birthweights. In the following code chunks, I show the process I used to come up with a linear regression model with the outcome birtweight `btw`. 

#### Fitting a model

**1. Load and clean the dataset for regression analysis** 

```{r}
birthweight_df = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    mrace = as.character(mrace), 
    mrace = recode(mrace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "8" = "Other"),
    mrace = fct_infreq(mrace),
    babysex = as.character(babysex),
    babysex = recode(babysex, "1" = "Male", "2" = "Female"),
    babysex = fct_infreq(babysex),
    frace = as.character(frace), 
    frace = recode(frace, "1" = "White", "2" = "Black", "3" = "Asian", "4" = "Puerto Rican", "9" = "Unknown"),
    frace = fct_infreq(frace),
    malform = as.character(malform),
    malform = recode(malform, "0" = "Absent", "1" = "Present"),
    malform = fct_infreq(malform)
    )
  
```

**2. Look at the data**

I'll first explore the three predictors that have been found to be associated with birthweight in published analyses. 

Birthweight by mother's age at delivery

```{r}
birthweight_df %>% 
  ggplot(aes(x = momage, y = bwt, color = mrace)) +
  geom_point()
```


Birthweight by average number of cigarettes smoked per day during pregnancy

```{r}
birthweight_df %>% 
  ggplot(aes(x = smoken, y = bwt, color = mrace)) +
  geom_point()
```

**3. Fit data**

Based on these plots, it looks like race and mom's age at birth may have a linear relationship with birthweight, so I will fit a linear model using both of those predictors. 

```{r}
fit = lm(bwt ~ momage + mrace, data = birthweight_df)
```

```{r}
fit %>% 
  broom::glance()
```

```{r}
fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  mutate(term = str_replace(term, "momage", "Mom's Age at Birth")) %>% 
  mutate(term = str_replace(term, "mrace", "Race: ")) %>% 
  knitr::kable(digits = 3)
```

**4. Add residuals**

```{r}
birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = mrace, y = resid)) +
  geom_violin()

birthweight_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = momage, y = resid)) +
  geom_point() +
  facet_wrap(. ~ mrace)
```

```{r}
modelr::add_predictions(birthweight_df, fit)
```
**5. Make plot of modeled residuals against fitted values**



#### Now I will compare my model to two others

* Length at birth and gestational age as predictors (main effects only)
* Head circumference, length, sex, and all interactions between these  three



# Problem 3

This problem uses 2017 Central Park weather data 

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```


